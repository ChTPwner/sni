name: Main

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ main ]

jobs:
  release-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
            exesuffix: .exe
          - os: windows-latest
            goos: windows
            goarch: "386"
            exesuffix: .exe
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: "386"
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v3.x

      - name: Set up linux dependencies
        if: ${{ matrix.goos == 'linux' }}
        run: sudo apt-get update && sudo apt-get install -y gcc libgtk-3-dev libappindicator3-dev

      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16

      - run: go test ./...

      - run: mkdir sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}
      - run: cp README.md sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}
      - run: cp LICENSE sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}
      - run: cp protos/sni/sni.proto sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}

      - run: >
          go build
          -ldflags="-X 'main.version=${{env.GITHUB_REF_SLUG}}' -X 'main.commit=${{env.GITHUB_SHA_SHORT}}' -X 'main.date=$(date +'%Y-%m-%dT%H:%M:%S')'"
          -o ./sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}/sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}${{matrix.exesuffix}}
          ./cmd/sni

      - uses: papeloto/action-zip@v1
        with:
          files: sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}/
          recursive: false
          dest: sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}.zip

      - uses: actions/upload-artifact@v1
        with:
          name: sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}.zip
          path: ${{ github.workspace }}/sni-${{env.GITHUB_REF_SLUG}}-${{matrix.goos}}-${{matrix.goarch}}.zip
